# Deployment

The project is set up to be easily deployed to Fly.io, so this guide will explain this workflow.

    ## Prerequisites

    1. Create an account at [Fly.io](https://fly.io).
    2. Download [flyctl](https://fly.io/docs/flyctl/): Fly.io command line tool
    3. Authenticate with `flyctl auth login`
    4. In the root of the project run `flyctl launch --no-deploy`. This will create prompt you to create an application on Fly.io with the information provided in the `fly.toml`.
    You will be asked if you want to update these settings. Here you can choose a server location that is more relevant. Ensure that the port is set to `8080`.

    ### Tip

    You can use the following command to generate your GHOST_CONTENT_API_KEY and JWT_SECRET

    ```bash
    # GHOST_CONTENT_API_KEY - follows format Ghost generates
    node -e "console.log(require('crypto').randomBytes(13).toString('hex'))"
    # JWT_SECRET
    node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
    ```

## Github Actions

For deployment through GitHub Actions:

1. **Get Deploy API Token**: Navigate to the newly created application in the Fly.io dashboard and get a deploy token.

2. **Set Secrets**: Configure necessary secrets in your GitHub repository settings.

3. Manually trigger by going to Actions tab and selecting `Fly Deploy`. Click `Run workflow` and enter the branch name to deploy.
   - You can update this action to trigger on push to `main` by changing the `on` section of the workflow file to `push: [main]`

## Command Line

For command line deployment:

### Set Secrets

Configure necessary environment secrets:

```
flyctl secrets set GHOST_CONTENT_API_KEY="my-api-key-value" \
   OWNER_EMAIL="my-email-value" \
   OWNER_PASSWORD="my-password-value" \
   MAILGUN_DOMAIN="somedomain" \
   MAILGUN_API_KEY="somekey" \
   MAILGUN_BASE_URL="mailgunbase" \
   JWT_SECRET="somejwtsecret" \
   SITE_TITLE="My Site" \
   SITE_DESCRIPTION="My website" \
   OWNER_NAME="Admin" \
   OWNER_SLUG="admin" \
   BLOG_URL="https://mysite.com" \
   COMMENT_SETTINGS="all"
```

### Deploy

Deploy your application with environment variables:

```bash
flyctl deploy
```

### Custom Domain and SSL

You can create an SSL certificate with `fly certs create example.com`. Then you'll need to create records on your domain registrar.

You can find detailed instructions [here](https://fly.io/docs/networking/custom-domains-with-fly/).
